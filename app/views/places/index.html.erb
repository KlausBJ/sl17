<p id='notice'><%= notice %></p>

<h1>Steder</h1>
<% p_names = [] %>
<% a_ids = [] %>
<% a_names = [] %>
<% a_tovholdere = [] %>
<% a_starttimes = [] %>
<% a_endtimes = [] %>
<% a_counter = [] %>
<% a_total = [] %>
<% rowspan = [] %>
<% @places.each_with_index do |place,index| %>
  <% p_names[index] = place.name %>
  <% a_ids[index] = place.a_ids.split(',') %>
  <% a_names[index] = place.a_names.split(',') %>
  <% a_starttimes[index] = place.starttimes.split(',') %>
  <% a_endtimes[index] = place.endtimes.split(',') %>
  <% a_tovholdere[index] = place.tovholdere.split(',') %>
<% end %>


<% times = (start_time.to_i..end_time.to_i).to_a.in_groups_of(30.minutes).collect(&:first).
  collect { |t| Time.at(t).utc.to_time_of_day } %>

<% (0..6).each do |index| %>
  <% day = Date.new(2017, 7, index + 8) %>
  <table>
    <tr>
      <th>
        <%= day %>
      </th>
      <% (0..p_names.length - 1).each do |place| %>
        <% a_counter[place] = 0 %>
        <% a_total[place] = a_names.length %>
        <th>
          <% p_names[place] %>
        </th>
      <% end %>
    </tr>
    <% times.each do |time| %>
      <% curr_time = day.at time %>
      <tr>
        <td>
          <%= "#{time.hour < 10 ? '0' : '' }#{time.hour}:#{time.min.zero? ? '00' : '30'}" %>
        </td>
        <% (0..p_names.length - 1).each do |place| %>
          <% if a_starttimes[a_counter[place]] == curr_time %>
            <td>
              <%= a_names[a_counter[place]] %>
              <% rowspan[place] = a_endtimes[a_counter[place]] - a_starttimes[a_counter[place]] / 30.minutes %>
            </td>
          <% else %>
            <% if rowspan[place] > 0 %>
              <% rowspan[place] -= 1 %>
              <% if rowspan[place] == 0 && a_starttimes[a_counter[place]] <= curr_time %>
                <% a_counter[place] += 1 %>
              <% end %>
            <% else %> # ledig tid starter her
              <% rowspan[place] =
                   (a_starttimes[a_counter[place]].nil? ? a_starttimes[a_counter[place]] : day.at(midnight)) -
                     curr_time / 30.minutes %>
              <td rowspan="<%= rowspan[place] %>">
              </td>
            <% end %>
          <% end %>
        <% end %>
      </tr>
    <% end %>
  </table>
<% end %>




<table>
  <thead>
    <tr>
      <%  %>
      <th>Navn</th>
      <th>Beskrivelse</th>
      <th>BegrÃ¦nset</th>
      <th colspan='3'></th>
    </tr>
  </thead>

  <tbody>
    <% @places.each do |place| %>
      <tr>
        <td><%= place.name %></td>
        <td><%= place.description %></td>
        <td><%= place.limited %></td>
        <td><%= link_to 'Vis', place %></td>
        <td><%= link_to 'Rediger', edit_place_path(place) %></td>
        <td><%= link_to 'Slet', place, method: :delete, data: { confirm: 'Er du sikker?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'Nyt Sted', new_place_path %>
